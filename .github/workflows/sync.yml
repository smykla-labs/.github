---
name: Sync All

on:
  workflow_dispatch:
    inputs:
      sync_labels:
        description: "Sync labels"
        required: false
        type: boolean
        default: true
      sync_files:
        description: "Sync files"
        required: false
        type: boolean
        default: true
      sync_settings:
        description: "Sync settings"
        required: false
        type: boolean
        default: true
      sync_smyklot:
        description: "Sync smyklot"
        required: false
        type: boolean
        default: true
      dry_run:
        description: "Dry run (no changes)"
        required: false
        type: boolean
        default: false

permissions: {}

jobs:
  trigger-syncs:
    runs-on: ubuntu-24.04
    outputs:
      triggered_runs: ${{ steps.trigger.outputs.runs }}
    steps:
      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Trigger sync workflows
        id: trigger
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          SYNC_LABELS: ${{ inputs.sync_labels }}
          SYNC_FILES: ${{ inputs.sync_files }}
          SYNC_SETTINGS: ${{ inputs.sync_settings }}
          SYNC_SMYKLOT: ${{ inputs.sync_smyklot }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## ðŸ”„ Triggering Sync Workflows" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          triggered_runs=""
          disabled_count=0
          skipped_count=0

          # Helper function to check if workflow is enabled
          is_workflow_enabled() {
            local workflow_file="$1"
            local state
            state=$(gh api "repos/$REPO/actions/workflows/$workflow_file" --jq '.state')
            [[ "$state" == "active" ]]
          }

          # Helper function to trigger workflow
          trigger_workflow() {
            local name="$1"
            local workflow_file="$2"
            local type="$3"
            local should_sync="$4"
            shift 4
            local extra_args=("$@")

            if [[ "$should_sync" != "true" ]]; then
              echo "- â­ï¸ $name skipped (disabled by user)" >> "$GITHUB_STEP_SUMMARY"
              ((skipped_count++))
              return
            fi

            if ! is_workflow_enabled "$workflow_file"; then
              echo "- ðŸš« $name skipped (workflow disabled)" >> "$GITHUB_STEP_SUMMARY"
              ((disabled_count++))
              return
            fi

            echo "Triggering $name..."
            gh workflow run "$workflow_file" --repo "$REPO" -f "dry_run=$DRY_RUN" "${extra_args[@]}"
            sleep 2
            run_id=$(gh run list --workflow="$workflow_file" --repo "$REPO" --limit 1 --json databaseId --jq '.[0].databaseId')
            triggered_runs="${triggered_runs}${type}:${run_id} "
            echo "- âœ… $name triggered (run: $run_id)" >> "$GITHUB_STEP_SUMMARY"
          }

          # Trigger each workflow
          trigger_workflow "Sync Labels" "sync-labels.yml" "labels" "$SYNC_LABELS"
          trigger_workflow "Sync Files" "sync-files.yml" "files" "$SYNC_FILES"
          trigger_workflow "Sync Settings" "sync-settings.yml" "settings" "$SYNC_SETTINGS"
          trigger_workflow "Sync Smyklot" "sync-smyklot.yml" "smyklot" "$SYNC_SMYKLOT" -f "use_latest=true"

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Report status
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "â„¹ï¸ **Dry run mode** - no changes will be made" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ $disabled_count -gt 0 ]]; then
            echo "âš ï¸ **Warning**: $disabled_count workflow(s) skipped due to being disabled (release may be in progress)" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "runs=${triggered_runs% }" >> "$GITHUB_OUTPUT"

  wait-and-summarize:
    runs-on: ubuntu-24.04
    needs: trigger-syncs
    if: needs.trigger-syncs.outputs.triggered_runs != ''
    steps:
      - name: Generate App Token
        id: token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: .github

      - name: Wait for workflows to complete
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          TRIGGERED_RUNS: ${{ needs.trigger-syncs.outputs.triggered_runs }}
        run: |
          echo "## â³ Waiting for Workflows" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          for run_info in $TRIGGERED_RUNS; do
            type="${run_info%%:*}"
            run_id="${run_info##*:}"
            echo "Waiting for $type sync (run: $run_id)..."
            gh run watch "$run_id" --repo "$REPO" || true
            echo "- âœ… $type sync completed" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: Download workflow summaries
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          REPO: ${{ github.repository }}
          TRIGGERED_RUNS: ${{ needs.trigger-syncs.outputs.triggered_runs }}
        run: |
          mkdir -p workflow-summaries

          for run_info in $TRIGGERED_RUNS; do
            type="${run_info%%:*}"
            run_id="${run_info##*:}"
            echo "Downloading workflow summary for $type (run: $run_id)..."
            gh run download "$run_id" --repo "$REPO" --name "workflow-summary-$type" --dir workflow-summaries/ || echo "Warning: No summary artifact for $type"
          done

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Generate consolidated summary
        uses: ./
        with:
          command: summary
          subcommand: generate
          token: ${{ steps.token.outputs.token }}
          type: all
          results_dir: workflow-summaries
          dry_run: ${{ inputs.dry_run }}
